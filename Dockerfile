# Stage 1: Build stage
FROM golang:1.22.5 AS builder

WORKDIR /app

RUN git clone https://github.com/scheduler0/scheduler0.git .

RUN go build -o scheduler0

RUN chmod +x /app/scheduler0

ENV SCHEDULER0_SECRET_KEY=AB551DED82B93DC8035D624A625920E2121367C7538C02277D2D4DB3C0BFFE94 \
    SCHEDULER0_AUTH_PASSWORD=admin \
    SCHEDULER0_AUTH_USERNAME=admin \
    SCHEDULER0_PROTOCOL=http \
    SCHEDULER0_HOST=127.0.0.1 \
    SCHEDULER0_PORT=9091 \
    SCHEDULER0_PEER_AUTH_REQUEST_TIMEOUT_MS=5 \
    SCHEDULER0_PEER_CONNECT_RETRY_MAX=10 \
    SCHEDULER0_PEER_CONNECT_RETRY_DELAY_SECONDS=2 \
    SCHEDULER0_BOOTSTRAP=true \
    SCHEDULER0_NODE_ID=1 \
    SCHEDULER0_RAFT_ADDRESS=127.0.0.1:7071 \
    SCHEDULER0_RAFT_TRANSPORT_MAX_POOL=1 \
    SCHEDULER0_RAFT_TRANSPORT_TIMEOUT=2 \
    SCHEDULER0_JOB_EXECUTION_RETRY_DELAY=1 \
    SCHEDULER0_JOB_EXECUTION_RETRY_MAX=5 \
    SCHEDULER0_MAX_WORKERS=5 \
    SCHEDULER0_JOB_QUEUE_DEBOUNCE_DELAY=2 \
    SCHEDULER0_MAX_MEMORY=5000 \
    SCHEDULER0_EXECUTION_LOG_FETCH_FA1N_IN=2 \
    SCHEDULER0_EXECUTION_LOG_FETCH_INTERVAL_SECONDS=2 \
    SCHEDULER0_JOB_INVOCATION_DEBOUNCE_DELAY=2 \
    SCHEDULER0_HTTP_EXECUTOR_PAYLOAD_MAX_SIZE_MB=2 \
    SCHEDULER0_REPLICAS='[{"nodeId": 1, "raft_address": "127.0.0.1:7071", "address": "http://127.0.0.1:9091"}]'

EXPOSE $SCHEDULER0_PORT

CMD ["/app/scheduler0", "start"]
